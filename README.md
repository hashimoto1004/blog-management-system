# 概要

前回でブログの CRUD 処理を実装しましたね！
普段みなさんが利用している Web サービスだと入力フォームに入力されていなかったらエラーが起きたり、システム内でエラーが起きたり、、、、（文言修正）

そこでバリデーションやエラーハンドリングをして、より実践編に移っていきます。

# DB でエラーが起きた場合のハンドリング

何かしらの理由で DB 操作がエラーになることがあります。
例えば DB が落ちていたり、データの不整合で該当のクエリが正常終了しなかったりと。
そこでエラーハンドリングを実装します。

試しにエラーハンドリングをしない場合、どうなるか確認してみましょう。
BlogRepositoryImpl.java で`SELECT *, `にして構文エラーを起こしてみましょう。

`http://localhost:8080/blogs`にアクセスしてみると、エラーは起きないものの、本来はブログのデータがあるのにも関わらず、ユーザーからはブログのデータが無いように感じてしまいます。

そこでエラーハンドリングをして適切なメッセージをユーザーに伝える必要があるのです。

## 例外クラス

`java/com/example/blog`に exception ディレクトリを作成し、`DatabaseException.java`を作成しエラーハンドリングを作成しましょう。
その際にエラーメッセージを受け取りましょう。

##　エラーハンドリング実装

### BlogRepositoryImpl

SQLException が発生した際に先ほど作成した例外を発生しましょう。
`データベースエラーです`というメッセージを入力してください。

### BlogService

BlogRepositoryImpl で発生しうる例外をハンドリングしましょう。

### BlogController

コントローラでエラーをハンドリングしましょう。
エラーメッセージはユーザーに見せるため、`システムエラーです`というメッセージにしましょう。

# バリデーション

## 空文字入力の場合

タイトルの入力フィールドに何も入力されない場合はタイトルなしのブログ記事が作られてしまいますね。
サービス仕様にもよりますが、一般的にはタイトルやコンテンツは空文字の入力は登録できないようにするのが一般的です。

以下はタイトルが空文字だった場合のハンドリングをしていきましょう。

### Exception

タイトルが空文字だった場合の例外を作成してください。

### Service

入力されたタイトルの内容を確認して、空文字であった場合は`タイトルは必須です。`というエラーメッセージを返却するようにしてください。
その際に先ほど作成した例外クラスを利用してください。

### Controller

タイトルが未入力だった場合のハンドリングを行い、`titleEmptyError`というキーでモデルにデータを登録してください。

### 動作確認

`localhost:8080/blogs/new`にアクセスをして、タイトルを未入力の状態で保存を行ってみてください。
そのデータが保存に失敗し、画面に`タイトルは必須です`というエラーメッセージが表示されたら正常に実装できております。

## コンテンツが空文字の場合

同様にコンテンツが空文字の場合も対応してみましょう。

### 動作確認

`localhost:8080/blogs/new`にアクセスをして、コンテンツを未入力の状態で保存を行ってみてください。
そのデータが保存に失敗し、画面に`コンテンツは必須です`というエラーメッセージが表示されたら正常に実装できております。

## 重複の場合

タイトルが重複している場合は、登録てきないようにします。

### Exception

重複の場合の例外クラスを作成しましょう。

### Repository

`countByTitle`という関数を作成し、文字列型を受け取り、数値型を返却するようにします。

### Repository の実装

先ほど作成した関数を使用し同じタイトルが DB に存在するか確認してましょう。
方法はいくつかありますが、今回は SQL でカウントの処理を行い、重複チェックを行いましょう。

### Service

重複チェックの関数を使用し、重複なら適切な例外を発生させましょう。

### Controller

タイトルが重複だった場合のハンドリングを行い、`titleDuplicateError`というキーでモデルにデータを登録してください。

### 動作確認

`localhost:8080/blogs/new`にアクセスをして、任意のタイトルで保存してください。
再度新規作成を行い、先ほどと同じタイトルで保存をして設定したエラーメッセージが表示されていたら正常に実装ができております。
