# 概要

前回、ブログの CRUD 処理を実装しましたね！
普段利用している Web サービスでは、入力フォームに適切な値が入力されなかったり、システム内でエラーが発生したりすると、エラーメッセージが表示されたり、エラーページに遷移することが一般的です。

そこで今回は、バリデーションやエラーハンドリングを行い、より実践的なアプリケーションの開発に進んでいきましょう。

## 事前準備(10min)

`java/com/example/blog`に exception ディレクトリを作成してください。

# DB 操作時のエラーハンドリング(30min)

何らかの理由で、DB 操作がエラーになることがあります。たとえば、DB が落ちていたり、SQL 実行でタイムアウトが発生したりすることです。このようなエラーに対するハンドリングを実装します。

まず、エラーハンドリングをしない場合にどうなるかを確認してみましょう。`BlogRepositoryImpl.java` で `SELECT aaa` のように構文エラーを発生させてみましょう。

`http://localhost:8080/blogs` にアクセスすると、エラーは表示されませんが、本来はブログのデータが存在するにもかかわらず、ユーザーにはブログのデータがないかのように見えてしまいます。

このため、エラーハンドリングを行い、適切なメッセージをユーザーに伝える必要があります。

## 例外クラスの作成(30min)

`DatabaseException.java` を作成してエラーハンドリングを行いましょう。このクラスでエラーメッセージを受け取るようにします。

## エラーハンドリングの実装

### BlogRepositoryImpl(90min)

`findAll()`で`SQLException` が発生した際に、先ほど作成した `DatabaseException` を発生させましょう。エラーメッセージとして「データベースエラーです」というメッセージを設定してください。

### BlogController(60min)

コントローラでエラーをハンドリングし、エラーページに遷移するようにしてください。

### 動作確認(30min)

`findAll()`のメソッドにおいてクエリの構文エラーを発生させ、エラーページに遷移することを確認してください。

# バリデーション

## 空文字入力の場合

タイトルの入力フィールドに何も入力されない場合、タイトルなしのブログ記事が作成されてしまいます。一般的には、タイトルやコンテンツが空文字で入力された場合は登録できないようにするのが通例です。

以下は、タイトルが空文字だった場合のハンドリング方法です。

### 例外クラスの作成(30min)

タイトルが空文字だった場合の例外クラスを作成してください。

### Service(60min)

入力されたタイトルが空文字であった場合、「タイトルは必須です」というエラーメッセージを返すようにしてください。この際に、先ほど作成した例外クラスを使用します。

### Controller(60min)

タイトルが未入力だった場合のハンドリングを行い、`titleEmptyError` というキーでモデルにデータを登録してください。

### 動作確認(30min)

`localhost:8080/blogs/new` にアクセスし、タイトルを未入力の状態で保存を行ってください。データの保存が失敗し、画面に「タイトルは必須です」というエラーメッセージが表示されたら、正常に実装できています。

## コンテンツが空文字の場合

- Service(60min)
- Controller(60min)

同様に、コンテンツが空文字の場合も対応してみましょう。

### 動作確認 (30min)

`localhost:8080/blogs/new` にアクセスし、コンテンツを未入力の状態で保存を行ってください。データの保存が失敗し、画面に「コンテンツは必須です」というエラーメッセージが表示されたら、正常に実装できています。

## 重複の場合

タイトルが重複している場合、登録できないようにします。

### 例外クラスの作成(30min)

タイトルの重複時に使用する例外クラスを作成しましょう。

### Repository(30min)

`countByTitle` というメソッドを作成し、文字列型の引数を受け取り、数値型を返却するようにします。

### Repository の実装(60min)

先ほど作成したメソッドを使用して、同じタイトルが DB に存在するか確認しましょう。方法はいくつかありますが、今回は SQL でカウント処理を行い、重複チェックを実施します。

### Service(60min)

重複チェックを行い、重複が確認された場合に適切な例外を発生させましょう。

### Controller(60min)

タイトルが重複していた場合のハンドリングを行い、`titleDuplicateError` というキーでモデルにデータを登録してください。

### 動作確認(30min)

`localhost:8080/blogs/new` にアクセスし、任意のタイトルで保存を行ってください。その後、再度新規作成を行い、先ほどと同じタイトルで保存し、設定したエラーメッセージが表示されたら、正常に実装ができています。

## 詳細ページに飛んだ際に 404 エラーページに遷移する処理を実装する

### 例外クラスの作成

`NotFoundException` という名前のカスタム例外クラスを作成してください。

### Repository の修正

`findById`で該当のデータがない場合は先ほどの例外を発生させてください。

### BlogController の修正

該当のデータがない場合は`404Error`ページに遷移するように修正してください。

### 動作確認

存在しないブログの ID を指定して `/blogs/{id}` にアクセスした際に、`404Error.html` が表示されることを確認してください。

## 他の処理でもエラーハンドリングを実装(120min)

リスト表示など、他の処理にもエラーハンドリングを実施しましょう。

### 動作確認(30min)

`BlogRepositoryImpl.java`で間違った SQL の構文にし例外を発生させ、適切にエラーページに遷移できているかを確認しましょう！

合計 930 分(15.5 時間)
